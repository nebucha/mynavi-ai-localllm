#!/bin/sh

#=========================================================================
# 作業用ディレクトリの作成と削除トラップの設定
#=========================================================================
tmp=/tmp/$(basename "$0" | tr ' ' '_' | tr '.' '_')_$$; mkdir $tmp
trap	"rm -rf \"$tmp\"" EXIT

#=========================================================================
# ワークスペースディレクトリへ移動
#=========================================================================
cd	$(dirname $(dirname $0))

#=========================================================================
# 未掲載ニュースのデータを整理
#=========================================================================
# POSTにURLが入力されていないtypescript.xmlファイルを抽出
ls	-d 20*							|
tail	-100							|
xargs	-L 1 -I @ grep -F -l '[POST:]' '@/typescript.xml'	> $tmp/all \
								2>/dev/null
# 未掲載ニュースを抽出
cat	$tmp/all						|
 grep	-E -v -- '(-REP/)|(-HOW/)|(-EXT/)'			> $tmp/news

# 未掲載レポートを抽出
cat	$tmp/all						|
grep	-E -- '(-REP/)|(-HOW/)|(-EXT/)'				> $tmp/reports

# 未掲載ニュース（後藤担当）を抽出
cat	$tmp/news						|
xargs	-L 1 -I @ grep -F -l '後藤大地' '@'			> $tmp/goto \
								2>/dev/null
# 未掲載ニュース（杉山担当）を抽出
cat	$tmp/news						|
xargs	-L 1 -I @ grep -F -l '杉山貴章' '@'			> $tmp/sugi \
								2>/dev/null
# 未掲載ニュース（後藤担当）のタイトルを抽出
cat	$tmp/goto						|
xargs	-L 1 -I @ 						\
	grep -oP '(?<=^   <title><p>).*?(?=</p></title>)' @ 	> $tmp/goto_titles \
								2> /dev/null
# 未掲載ニュース（杉山担当）のタイトルを抽出
cat	$tmp/sugi						|
xargs	-L 1 -I @ 						\
	grep -oP '(?<=^   <title><p>).*?(?=</p></title>)' @ 	> $tmp/sugi_titles \
								2> /dev/null
# 未掲載レポートのタイトルを抽出
cat	$tmp/reports						|
xargs	-L 1 -I @ 						\
	grep -oP '(?<=^   <title><p>).*?(?=</p></title>)' @ 	> $tmp/report_titles \
								2> /dev/null

#=========================================================================
# メールの本文を生成して出力
#=========================================================================
mon=$(date +%Y年%m月)
num1=$(cat $tmp/goto $tmp/sugi | wc -l | awk '{print $1}')
num2=$(cat $tmp/reports | wc -l | awk '{print $1}')

cat	<<EOF
お世話になっております。後藤です。

${mon}の弊社割り当て予算分ニュース記事について、入稿済みで未掲載の記事は次の${num1}本です。

後藤担当
$(cat $tmp/goto_titles | sed 's/^/　・/')

杉山担当
$(cat $tmp/sugi_titles | sed 's/^/　・/')

上記未掲載分ニュースがすべて掲載された場合に予算枠使い切りです。掲載が難しいものがあればその分を本日分のニュースに回そうと考えておりますので、教えてください。

入稿済みで未掲載のレポートは次の${num2}本です。

レポート
$(cat $tmp/report_titles | sed 's/^/　・/')

報告以上です。よろしくお願い致します。
EOF
