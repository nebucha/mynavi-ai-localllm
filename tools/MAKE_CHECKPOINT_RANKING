#!/bin/sh -xv
#
# Copyright (c) 2018-2020,2022,2023 Daichi GOTO <daichi@ongs.co.jp>
#
# This software is proprietary and not allowed to use for commercial
# purpose without a license.  Please contact daichi@ongs.co.jp
# for the details.

## MAKE_RANKINGMALWARE
##	Check Point Software Technologiesマルウェアランキング記事を作成
##	MAKE_RANKINGMALWARE [-h] url dirname title
##		url:		記事のURL
##		dirname:	記事のディレクトリ名
##		title:		記事のタイトル
##		-h:		使い方を表示

# コマンドパスの設定
PATH="$(dirname $0):$PATH"

#================================================================
# 作業用ディレクトリの作成と削除トラップの設定
#================================================================
tmp=/tmp/$$
trap	"rm -f \"$tmp-\"" EXIT

#================================================================
# ページソースを取得
#================================================================
netcat	"$1"							> $tmp-src

#================================================================
# テーブルディレクトリを作成
#================================================================
tdir=$(dirname $0)/../$2/tables
mkdir	$tdir

#================================================================
# マルウェアランキングテーブルを作成
#================================================================
cat<<EOF							> $tdir/001.tsv
順位	トップマルウェア	前月比較
EOF
cat	$tmp-src						|
# 該当部分を抽出
sed	-n '/<u>Top [Mm]alware [Ff]amilies/,/Top Attacked Industries/p' |
grep	'^<li>'							|
# 不要なデータを削除
sed	's,<[^>]*>,,g'						|
sed	's/&#8211;/–/g'						|
sed	's/–.*$//'						|
# 加工できるように調整
sed	's/↑/↑ /g'						|
sed	's/↓/↓ /g'						|
sed	's/↔/↔ /g'						|
sed	's/&#x2194;/↔ /g'					|
# テーブル形式へ加工
awk	'
BEGIN	{
	i=1
}
{
	j=$1
	$1=""
	gsub(/^ +/,"",$0)
	gsub(/ +$/,"",$0)
	print i++ "\t" $0 "\t" j
}
'								|
cat								>>$tdir/001.tsv

#================================================================
# セキュリティ脆弱性ランキングテーブルを作成
#================================================================
cat<<EOF							> $tdir/002.tsv
順位	トップセキュリティ脆弱性	前月比較
EOF

cat	$tmp-src						|
# 該当部分を抽出
sed	-n '/<u>Top [Ee]xploited [Vv]ulnerabilities/,/Top Mobile Malwares/p' |
grep	'^<li>'							|
# 不要なデータを削除
sed	's,<[^>]*>,,g'						|
sed	's/&#8211;/–/g'						|
sed	's/–.*$//'						|
# 加工できるように調整
sed	's/↑/↑ /g'						|
sed	's/↓/↓ /g'						|
sed	's/↔/↔ /g'						|
sed	's/&#x2194;/↔ /g'					|
# テーブル形式へ加工
awk	'
BEGIN	{
	i=1
}
{
	j=$1
	$1=""
	gsub(/^ +/,"",$0)
	gsub(/ +$/,"",$0)
	print i++ "\t" $0 "\t" j
}
'								|
cat								>>$tdir/002.tsv

#================================================================
# モバイルマルウェアランキングテーブルを作成
#================================================================
cat<<EOF							> $tdir/003.tsv
順位	トップモバイルマルウェア
EOF

cat	$tmp-src						| # 該当データ絞込
# 該当部分を抽出
sed	-n '/<u>Top Mobile Malwares/,//p'			|
grep	'^<li>'							|
# 不要なデータを削除
sed	's,<[^>]*>,,g'						|
sed	's/&#8211;/–/g'						|
sed	's/–.*$//'						|
# テーブル形式へ加工
awk	'
BEGIN	{
	i=1
}
{
	gsub(/^ +/,"",$0)
	gsub(/ +$/,"",$0)
	print i++ "\t" $0
}
'								|
cat								>>$tdir/003.tsv

#================================================================
# 記事の原型を作成
#================================================================
MAKE_TYPESCRIPT 						\
	"$@" 

#================================================================
# 作業に使った一時ファイルを削除
#================================================================
rm      -f $tmp-*
